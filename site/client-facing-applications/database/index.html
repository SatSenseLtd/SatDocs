
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.5.2">
    
    
      
        <title>Overview - SatDocs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.9f9400aa.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#ef5552">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="red" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#overview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SatDocs" class="md-header__button md-logo" aria-label="SatDocs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SatDocs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Overview
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SatDocs" class="md-nav__button md-logo" aria-label="SatDocs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    SatDocs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        SatSense Documentation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../AWS/" class="md-nav__link">
        Setting up AWS for processing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../daemon/" class="md-nav__link">
        SatDaemon (SQLAlchemy Version)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../dataprocessing/" class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../jira/" class="md-nav__link">
        Jira
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../sftp_user_setup/" class="md-nav__link">
        Sftp user setup
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Client facing applications
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Client facing applications" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Client facing applications
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../admin/" class="md-nav__link">
        Admin Suite (satadmin)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Overview
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../demo-portal/" class="md-nav__link">
        Demo portal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../geoserver/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        SatSense Client-Facing Applications Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../portal/" class="md-nav__link">
        Portal/SatShop (satportal)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../satdes/" class="md-nav__link">
        Satdes (Data Extraction Service)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../satdom-scripts/" class="md-nav__link">
        Satdom Scripts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../satpgi/" class="md-nav__link">
        Postgres Ingester (satpgi)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tileserver-qgis-fiddle/" class="md-nav__link">
        Integrating Tileservers into QGIS (fiddle)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tileservers/" class="md-nav__link">
        Tileservers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../webmisc/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../what-mike-does/" class="md-nav__link">
        "What Mike does"
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_15" type="checkbox" id="__nav_7_15" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_15">
          Portal
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Portal" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_15">
          <span class="md-nav__icon md-icon"></span>
          Portal
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../portal/portal-overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="overview">Overview</h1>
<p>The portal and api have access to SatSense InSAR and user data contained in a <a href="https://www.postgresql.org/">PostgreSQL</a> database (or sometimes known as a "postgres" database).  We are currently using PostgreSQL version 11.</p>
<p>Since the InSAR and user data is geographically aware, we use the extension <a href="https://postgis.net/">PostGIS</a>.  PostGIS is a highly capable open source extension to PostgreSQL that allows efficient storage and queries of geographical datasets.</p>
<p>This page aims to be a reference for how to install, set up and use PostgreSQL and PostGIS.  It aims to include instructions specific to our use case, but also to be a generic reference as well.  All links to PostgreSQL documentation will be to version 11 documentation.</p>
<p>Contents:
1. <a href="#1-installation-of-postgresql-and-postgis">Installation of PostgreSQL and PostGIS</a>
2. <a href="#2-user-creation">User Creation</a> 
3. Tuning (TODO)
4. <a href="#4-backing-up-procedure">Backing Up Procedure</a>
5. <a href="#5-satsense-postgres-ingester">SatSense Postgres Ingester</a>
6. <a href="#">Current Database Setup</a></p>
<h1 id="1-installation-of-postgresql-and-postgis">1. Installation of PostgreSQL and PostGIS</h1>
<h2 id="production-on-centos-7">Production on Centos 7</h2>
<p>TODO</p>
<h2 id="postgresql-12-postgis-on-ubuntu-2004">PostgreSQL 12 + PostGIS on Ubuntu 20.04</h2>
<h3 id="postgresql">PostgreSQL</h3>
<p>Install postgres via </p>
<pre><code class="language-commandline">sudo apt install postgresql postgresql-contrib
</code></pre>
<p>To check it's working correctly, you can log in to <code>psql</code> as postgres</p>
<pre><code class="language-commandline">sudo su postgres
psql
</code></pre>
<h3 id="change-data-directory">Change data directory</h3>
<p>The following assumes a clean installation of postgres.</p>
<p>Open the config:</p>
<pre><code class="language-commandline">vi /etc/postgresql/12/main/postgresql.conf 
</code></pre>
<p>and change the value <code>data_directory</code> to the location you'd like.  You also need to initialise this directory via:</p>
<pre><code class="language-commandline">/usr/lib/postgresql/12/bin/initdb &lt;data_directory&gt;
</code></pre>
<p>The change requires a restart of the postgresql process:</p>
<pre><code class="language-commandline">sudo systemctl restart postgresql
</code></pre>
<p>You can then log into <code>psql</code> and check it has been update by using the command <code>SHOW data_directory;</code>.</p>
<h3 id="change-authentication">Change authentication</h3>
<p>By default, postgresql only allows peer authentication.  This means that the linux user name has to match the postgresql user name for you to log in.  To allow logging in by using a password, first set a password for the postgresql <code>postgres</code> user by running the following in <code>psql</code>:</p>
<pre><code class="language-postgresql">ALTER ROLE postgres WITH PASSWORD 'new_password';
</code></pre>
<p>Then edit the file</p>
<pre><code class="language-commandline">sudo vi /etc/postgresql/12/main/pg_hba.conf
</code></pre>
<p>and change all lines that are similar to:</p>
<pre><code class="language-commandline">local   all             all                                     peer
</code></pre>
<p>to </p>
<pre><code class="language-commandline">local   all             all                                     md5
</code></pre>
<p>And restart the postgres service:</p>
<pre><code class="language-commandline">sudo systemctl restart postgresql
</code></pre>
<p>You'll then be able to log in using a password, try using</p>
<pre><code class="language-commandline">psql -U postgres
</code></pre>
<p>where <code>-U</code> means the postgres user name you are providing.</p>
<h3 id="postgis">PostGIS</h3>
<p>Add the ubuntugis ppa:</p>
<pre><code class="language-commandline">sudo add-apt-repository ppa:ubuntugis/ppa
sudo apt-get update
</code></pre>
<p>And then postgis:</p>
<pre><code class="language-commandline">sudo apt install postgis postgresql-12-postgis-3
</code></pre>
<h1 id="2-user-creation-and-permissions">2. User Creation and Permissions</h1>
<p>In the following, replace text surrounded '&lt;' and '&gt;' with values you would like.  The following assumes that you are connected to postgresql via <code>psql</code> as a superuser (e.g. postgres). </p>
<h2 id="create-new-user">Create New User</h2>
<p>To create a new user:</p>
<pre><code>\set usertograntaccessto '&lt;portal_user&gt;'
CREATE USER :usertograntaccessto WITH ENCRYPTED PASSWORD '&lt;password&gt;';
</code></pre>
<p>where <code>&lt;password&gt;</code> is sufficiently strong, it is recommended to use a random password generator. The line <code>\set usertograntaccessto '&lt;portal_user&gt;'</code> sets a variable in the <code>psql</code> session - the value is called with a preceding colon i.e. <code>:usertograntaccessto</code>.</p>
<h2 id="grant-read-only-privileges">Grant Read Only Privileges</h2>
<p>We assume that the variable <code>:usertograntaccessto</code> is set as per the "Create New User" section. To grant read only access to a database:</p>
<pre><code>\c &lt;db name&gt;
\set dbname '&lt;db name&gt;'
GRANT CONNECT ON DATABASE :dbname TO :usertograntaccessto;
GRANT USAGE ON SCHEMA public TO :usertograntaccessto;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO :usertograntaccessto;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO :usertograntaccessto;
</code></pre>
<p>Note that it is recommended to connect to the database first - the last three lines don't specify which database to grant permissions to, rather it is the database you are connected to that defines this.</p>
<p>The line <code>ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO :usertograntaccessto;</code> will mean that if tables are added to the schema, then <code>:usertograntaccessto</code> will automatically be given the <code>SELECT</code> privilege.</p>
<pre><code>Important
Default privileges will only be granted to tables added by the same user as who ran the line &quot;ALTER DEFAULT PRIVILEGES...&quot;. That is, if &quot;postgres&quot; ran the line &quot;ALTER DEFAULT PRIVILEGES...&quot;, then &quot;postgres&quot; must be the user that changes the schema.
</code></pre>
<h2 id="grant-read-write-privileges">Grant Read Write Privileges</h2>
<h3 id="select-insert-update">SELECT, INSERT, UPDATE</h3>
<p>We assume that the variable <code>:usertograntaccessto</code> is set as per the "Create New User" section. To grant <code>SELECT, INSERT, UPDATE</code> access to user database:</p>
<pre><code>\c &lt;db name&gt;
\set dbname '&lt;db name&gt;'
GRANT CONNECT ON DATABASE :dbname TO :usertograntaccessto;
GRANT USAGE ON SCHEMA public TO :usertograntaccessto;
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO :usertograntaccessto;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE ON TABLES TO :usertograntaccessto;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO :usertograntaccessto;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO :usertograntaccessto;
</code></pre>
<p>As above, it is recommended to connect to the database first (i.e. with the first line).  Also as above, lines starting with <code>ALTER DEFAULT PRIVILEGES</code> will mean that if tables are added to the schema, then <code>:usertograntaccessto</code> will automatically be given the correct privileges.</p>
<pre><code>Important
Default privileges will only be granted to tables added by the same user as who ran the line &quot;ALTER DEFAULT PRIVILEGES...&quot;. That is, if &quot;postgres&quot; ran the line &quot;ALTER DEFAULT PRIVILEGES...&quot;, then &quot;postgres&quot; must be the user that changes the schema.
</code></pre>
<h3 id="select-insert-update-delete">SELECT, INSERT, UPDATE, DELETE</h3>
<p>We note that some apps may also require the <code>DELETE</code> privilege.  For instance, the admin site has the ability to delete users, whereas the portal does not. To grant <code>SELECT, INSERT, UPDATE, DELETE</code> access to user database:</p>
<pre><code>\c &lt;db name&gt;
\set dbname '&lt;db name&gt;'
GRANT CONNECT ON DATABASE :dbname TO :usertograntaccessto;
GRANT USAGE ON SCHEMA public TO :usertograntaccessto;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO :usertograntaccessto;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO :usertograntaccessto;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO :usertograntaccessto;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO :usertograntaccessto;
</code></pre>
<h2 id="change-table-ownership">Change Table Ownership</h2>
<p>We finish by noting that Postgres Ingester requires greater access to tables than SELECT, INSERT, UPDATE and DELETE.  Because it runs manual vacuuming, the user needs to own the tables it vacuums.  You can change user ownership via:</p>
<pre><code>ALTER TABLE &lt;table_name&gt; OWNER TO &lt;new_owner&gt;;
</code></pre>
<p>Note that it is easiest to run this command as a superuser (e.g. <code>postgres</code>).</p>
<h2 id="query-current-permissions">Query Current Permissions</h2>
<p>Whilst connected to a you can use </p>
<pre><code class="language-psql">\dp
</code></pre>
<p>to query current permissions.  And</p>
<pre><code class="language-psql">\ddp
</code></pre>
<p>to query the default permissions for all users.</p>
<h1 id="3-tuning">3. Tuning</h1>
<p>See https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server</p>
<p>Open the postgresql.conf file, on live this is </p>
<pre><code class="language-commandline">sudo vi /data/pgdata11/postgresql.conf
</code></pre>
<p>And change the following:
* You could increase <code>max_connections</code> (live is 200).  Much more than a few hundred, should consider connection pooling (<a href="https://www.pgbouncer.org/">PgBouncer</a>).
* Increase <code>shared_buffers</code> (live is 8GB).
* Increase <code>work_mem</code> (live is 40MB).
* Increase <code>maintenance_work_mem</code> (live is 1GB).
* Increase <code>effective_cache_size</code>, advice ranges from 1/4 to 1/2 of RAM, live is 32GB.</p>
<h1 id="4-backing-up-procedure">4. Backing Up Procedure</h1>
<h2 id="pg_dump">pg_dump</h2>
<p>To back up our databases, we currently use the PostgreSQL utility <a href="https://www.postgresql.org/docs/11/app-pgdump.html">pg_dump</a>.  This produces a single file which can then be used to restore in another PostgreSQL instance.</p>
<h3 id="example-usage">Example usage</h3>
<pre><code>pg_dump database_name -Fc -p 5440 -U postgres -v &gt; name_of_backup.bak
</code></pre>
<p>In the above:
* <code>database_name</code> should be replaced with the name of the database that you would like to back up.
* <code>-Fc</code> denotes that pg_dump should use a custom format.  The format here is <code>.bak</code>, which is determined by the suffix of the out file name. For more options, see the <a href="https://www.postgresql.org/docs/11/app-pgdump.html">docs</a>.
* <code>-p 5440</code> denotes the port that the PostgreSQL is listening on.
* <code>-U postgres</code> is the user that <code>pg_dump</code> should connect to the database as.
* <code>-v</code> adds verbosity. A back up of the live InSAR database can take a long time (2 days).
* <code>name_of_backup.bak</code> should be replaced with the name of the back up file you'd like to create.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<ul>
<li>If you get an error like "server mismatch error" then it's possible that more than one version of <code>pg_dump</code> is installed.  Check that you are calling the correct version, it should be bundled with the postgres installation.  For example the current server's <code>pg_dump</code> is at <code>/usr/pgsql-11/bin/pg_dump</code>.</li>
</ul>
<h2 id="set-up-pg_dump-cron-job">Set up pg_dump cron job</h2>
<p>It is possibly a good idea to set up a separate user for cron jobs:</p>
<pre><code>sudo useradd cronuser
</code></pre>
<p>It might be a good idea to create a readonly user in postgreSQL as well:</p>
<pre><code>CREATE USER cronuser WITH ENCRYPTED PASSWORD '&lt;pg_password&gt;';
GRANT CONNECT ON DATABASE &lt;database_name&gt; TO cronuser;
\c &lt;database_name&gt;
GRANT USAGE ON SCHEMA public TO cronuser;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO cronuser;
GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO cronuser;
GRANT USAGE ON SCHEMA topology TO cronuser;
GRANT SELECT ON ALL TABLES IN SCHEMA topology TO cronuser;
GRANT SELECT ON ALL SEQUENCES IN SCHEMA topology TO cronuser;
</code></pre>
<p>It is not a good idea to put the cronuser <code>&lt;pg_password&gt;</code> in the cron file.  Instead, we create a <code>.pgpass</code> file.  As the linux user <code>cronuser</code>, create the file</p>
<pre><code>touch ~/.pgpass
chmod 0600 ~/.pgpass
</code></pre>
<p>which should be populated with the structure <code>server:port:database:username:password</code>.  For example, inserting the line:</p>
<pre><code>localhost:5440:*:cronuser:&lt;pg_password&gt;
</code></pre>
<p>will allow credentials to any database (assuming <code>cronuser</code> has the correct permissions).  </p>
<p>Now run</p>
<pre><code>crontab -e
</code></pre>
<p>and insert the something like:</p>
<pre><code>0 22 * * * /usr/pgsql-11/bin/pg_dump &lt;database_name&gt; -Fc -w -p 5440 -U cronuser &gt; /path/to/backups/database_name_$(date +&quot;\%Y\%m\%d&quot;).bak
</code></pre>
<p>which will back up the database everyday at 22:00.  Notice that we've escaped '%' and <strong>make sure</strong> you also enter a new line after the above line.  A lovely <em>feature</em> of crontab is that they don't run commands without a new line after them.</p>
<h2 id="restoring-a-bak-file">Restoring a .bak file</h2>
<p>For the following commands, you many need to use <code>-p &lt;port&gt; -U &lt;username&gt;</code>, the commands may also suffer a similar "server mismatch error" to <code>pg_dump</code>. First create a new database:</p>
<pre><code>createdb -T template0 mynewdb
</code></pre>
<p>Here:
* <code>-T template0</code> means that nothing is created in the new database.  By default, <code>createdb</code> will use <code>template1</code> which may include some default schemas which you will not need.
* <code>mynewdb</code> should be replaced with name of the new database you'd like to create.  It should not exist.
Once the database has been created, you can restore the back up:</p>
<pre><code>pg_restore -d mynewdb -v name_of_backup.bak
</code></pre>
<ul>
<li><code>-d mynewdb</code> is the database name, as above.</li>
<li><code>-v</code> adds verbosity.</li>
<li><code>name_of_backup.bak</code> is the name of the back up file you'd like to restore.</li>
</ul>
<p>We note that the back up will try to restore the user/role access defined on the original database.  The <code>pg_restore</code> function will show some errors if the users/roles don't exist.  You shouldn't need to worry, the data should have restored fine but you will need to add any user access that you need.</p>
<p>Sometimes the <code>pg_restore</code> command can fail with an error like:</p>
<pre><code>pg_restore: [archiver] unsupported version (1.14) in file header
</code></pre>
<p>This may be due to using the version of pg_restore which is within your conda environment. Deactivate the conda environment and try rerunning the command.</p>
<p>After restoring the backup, it is recommended to run </p>
<pre><code>ANALYSE;
</code></pre>
<p>whilst connected to the database via <code>psql</code>. Here is some brief information about <a href="https://andreigridnev.com/blog/2016-04-01-analyze-reindex-vacuum-in-postgresql/">ANALYSE</a>:</p>
<pre><code>PostgreSQL ANALYZE command collects statistics about specific table columns, entire table, or entire database. The PostgreSQL query planner then uses that data to generate efficient execution plans for queries.
</code></pre>
<h1 id="5-satsense-postgresql-ingester">5. SatSense PostgreSQL Ingester</h1>
<p>The <a href="https://gitlab.com/SatSenseLtd/postgresingester">SatSense PostgreSQL Ingester</a> (SatPGI) handles all updating of the SatSense InSAR dataset.  Documentation on how to checkout a development/production instance of SatPGI is held in the project README. This chapter is intended to be supplementary to that README; the contents are:</p>
<ol>
<li>Current Installation Details (TODO)</li>
<li>Setting Up A User (TODO)</li>
<li>Vacuuming.</li>
</ol>
<h2 id="3-vacuuming">3. Vacuuming</h2>
<h3 id="introduction">Introduction</h3>
<p>PostgreSQL is based on a "Multi Version Concurrency Control" (MVCC) architecture.  Here is quite a good post about MVCC: </p>
<pre><code>http://shiroyasha.io/multiversion-concurrency-control.html
</code></pre>
<p>The important take away is that when updating (or deleting) a row in the database, there can be two "versions" (called tuples) of that row.  A query will get a particular tuple depending on when the query is run.  </p>
<p>Some of the database transactions that SatPGI runs are very long running. Queries that are run in the duration of one of these transactions will not see any updated data; they will read the old tuples.  However, queries run after a transaction has finished will see the updated tuples and not be able to read the old tuples.</p>
<p>A priori, a tuple does not know if it is able to be read (known as live) or not (known as dead).  There needs to be a process which detects dead tuples and deletes them.  This process is known as "vacuuming".</p>
<p>By default, PostgreSQL automates a periodic vacuuming process (autovacuuming). However, if large updates or deletes are run then autovaccuming may not be enough and a database can grow massively as it will be storing multiple tuples for each row (effectively doubling/tripling the storage size of that row). </p>
<p>To help mitigate this problem, SatPGI will manually run Vacuum statements after it has run large updates.  So a SatPGI user should not have to worry too much, however this section should help anyone who wants to debug/further investigate vacuuming.</p>
<p>For reference, the PostgreSQL documentation page for vacuuming can be found here:</p>
<pre><code>https://www.postgresql.org/docs/11/sql-vacuum.html
</code></pre>
<h3 id="analysing">Analysing</h3>
<p>Connect to the database using <code>psql</code> and then run the following to get statistics about each table:</p>
<pre><code>SELECT relname AS TableName, n_live_tup, n_dead_tup, last_vacuum, last_autovacuum FROM pg_stat_user_tables;
</code></pre>
<p>In the above query:
* n_live_tup denotes the number of live tuples in the table;
* n_dead_tup denotes the number of dead tuples in the table;
* last_vacuum is a time stamp of when vacuum was last manually run (or null for never);
* last_autovacuum is a time stamp of when vacuum was last automatically run (or null for never);</p>
<p>The above statistics are only an estimation and certain processes (such as vacuuming) can update these statistics (finding out exactly when these stats are updated are a TODO).</p>
<h3 id="satpgis-vacuuming-implementation">SatPGI's vacuuming implementation</h3>
<p>SatPGI applies a standard (as opposed to a "full") vacuum to points tables that have just had large updates run on them.  This type of vacuum does not apply an exclusive lock on the table (as opposed to full vacuum which does) but it can be less effective at releasing hard disk space back to the system.  Even if this is that case, the space can be still be used for new/updated rows for the table in question.</p>
<p>The vacuum process cannot be run inside a transaction, as a result we have defined a OutOfTransactionUnitOfWork object (see <a href="https://gitlab.com/SatSenseLtd/satsense-domain/-/blob/master/satsense_core/data/unit_of_work.py">unit_of_work.py</a>) which will handle this process for us.</p>
<p>Another interesting feature of vacuuming is that it must be run by either:
* a database superuser (such as postgres);
* the owner of the database containing the table being vacuumed;
* the owner of the table being vacuumed.</p>
<p>In the interest of giving the least amount of privileges, we opt for the last option for the user that SatPGI uses to connect to the database with.  One can alter the owner of a table via the command:</p>
<pre><code>ALTER TABLE &lt;table_name&gt; OWNER TO &lt;new_owner&gt;;
</code></pre>
<p>Note that it is easiest to run this command as a superuser (although it is possible to run it without the superuser privilege).</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../api/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Overview
            </div>
          </div>
        </a>
      
      
        
        <a href="../demo-portal/" class="md-footer__link md-footer__link--next" aria-label="Next: Demo portal" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Demo portal
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.39f04ddb.min.js"></script>
      
    
  </body>
</html>